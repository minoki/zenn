---
title: "Cè¨€èªã®inlineé–¢æ•°ã«ã¤ã„ã¦"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [cè¨€èª]
published: false
---

C99ä»¥é™ã®Cè¨€èªã«ã¯**ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³é–¢æ•°**ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚æ©Ÿèƒ½è‡ªä½“ã¯æœ‰åã‹ã¨æ€ã„ã¾ã™ãŒã€é‡ç®±ã®éš…ã‚’ã¤ã¤ãã«è¡Œãã¨æ„å¤–ã¨çŸ¥ã‚‰ã‚Œã¦ã„ãªã„ã“ã¨ãŒã‚ã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³é–¢æ•°ã‚’æ·±æ˜ã‚Šã—ã¾ã™ã€‚ã‚ãã¾ã§**Cè¨€èªã‚’å¯¾è±¡ã¨ã—ã€C++ã¯å¯¾è±¡ã¨ã—ã¾ã›ã‚“**ã€‚

ã“ã®è¨˜äº‹ã§ã¯ç‰¹ã«ã€**`static` ã˜ã‚ƒãªã„ `inline` é–¢æ•°**ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

## é–¢æ•°å®šç¾©ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒ»ãƒªãƒ³ã‚¯ã«ã¤ã„ã¦ã®åŸºæœ¬

ã¾ãšã¯ã€è¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãªã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨é–¢æ•°ã®å®šç¾©ã«ã¤ã„ã¦ãŠã•ã‚‰ã„ã—ã¾ã™ã€‚

æ¬¡ã®ã‚ˆã†ã«ã€`foo1.c` ã¨ `main1.c` ã‹ã‚‰ãªã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```c:foo1.c
#include <stdio.h>

int add(int a, int b)
{
    return a + b;
}

void foo(void)
{
    printf("foo: %p, %d\n", add, add(3, 5));
}
```

```c:main1.c
#include <stdio.h>

extern int add(int a, int b);
extern void foo(void);

int main(void)
{
    printf("main: %p, %d\n", add, add(3, 5));
    foo();
}
```

```
$ cc -o exe1 foo1.c main1.c
$ ./exe1
main: 0x102433ec0, 8
foo: 0x102433ec0, 8
```

é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ç’°å¢ƒã«ã‚ˆã£ã¦ã€ã‚ã‚‹ã„ã¯å®Ÿè¡Œã”ã¨ã«å¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€ä»–ã¯æ™®é€šã§ã™ã­ã€‚

Cè¨€èªã®ç”¨èªã§è¨€ã†ã¨ã€`main1.c` ã¨ `foo1.c` ã¯ç•°ãªã‚‹**ç¿»è¨³å˜ä½** (translation unit; C17 5.1.1.1) ã«ãªã‚Šã¾ã™ã€‚`add` ã¨ `foo` ã¯**å¤–éƒ¨çµåˆ**ã¾ãŸã¯**å¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸** (external linkage; C17 6.2.2) ã‚’æŒã¤ãŸã‚ã€ç•°ãªã‚‹ç¿»è¨³å˜ä½ã§ã‚ã£ã¦ã‚‚åŒã˜å®Ÿä½“ã‚’å‚ç…§ã—ã¾ã™ã€‚`add` ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒåŒä¸€ã§ã‚ã‚‹ã“ã¨ãŒãã®è¨¼æ‹ ã§ã™ã€‚

ä»Šåº¦ã¯ã€`add` ã®å®šç¾©ã‚’ `static` ä»˜ãã®ã‚‚ã®ã«å¤‰ãˆã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```c:foo2.c
#include <stdio.h>

static int add(int a, int b)
{
    return a + b;
}

void foo(void)
{
    printf("foo: %p, %d\n", add, add(3, 5));
}
```

```c:main2.c
#include <stdio.h>

extern int add(int a, int b);
extern void foo(void);

int main(void)
{
    printf("main: %p, %d\n", add, add(3, 5));
    foo();
}
```

ã“ã‚Œã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒ»ãƒªãƒ³ã‚¯ã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ï¼š

```
$ cc -o exe2 foo2.c main2.c
Undefined symbols for architecture arm64:
  "_add", referenced from:
      _main in main2-846628.o
      _main in main2-846628.o
ld: symbol(s) not found for architecture arm64
clang: error: linker command failed with exit code 1 (use -v to see invocation)
```

Cè¨€èªã®ç”¨èªã§è¨€ã†ã¨ã€`foo2.c` ã§ã® `add` ã®å®šç¾©ã¯ `static` ãŒã¤ã„ãŸã“ã¨ã«ã‚ˆã‚Š**å†…éƒ¨çµåˆ**ã‚ã‚‹ã„ã¯**å†…éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸** (internal linkage) ã‚’æŒã¤ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ä¸€æ–¹ã§ `main2.c` ã§ã® `add` ã¯å¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã®ã¾ã¾ã§ã™ã€‚å¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã‚’æŒã¤ `add` ãŒä½¿ç”¨ã•ã‚ŒãŸã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€ãã®ï¼ˆå¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã‚’æŒã¤ `add` ã®ï¼‰å®šç¾©ãŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ä¸­ã«å­˜åœ¨ã—ãªã„ã®ã§ã€ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ï¼ˆC17 6.9 æ®µè½5ï¼‰ã€‚

ä»Šåº¦ã¯ã€`main3.c` ã§ `add` ã‚’ `static` ä»˜ãã§å®šç¾©ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```c:foo3.c
#include <stdio.h>

static int add(int a, int b)
{
    return a + b;
}

void foo(void)
{
    printf("foo: %p, %d\n", add, add(3, 5));
}
```

```c:main3.c
#include <stdio.h>

static int add(int a, int b)
{
    return a + b;
}

extern void foo(void);

int main(void)
{
    printf("main: %p, %d\n", add, add(3, 5));
    foo();
}
```

```
$ cc -o exe3 foo3.c main3.c
$ ./exe3
main: 0x104157f50, 8
foo: 0x104157ee0, 8
```

ä»Šåº¦ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒé€šã‚Šã¾ã—ãŸãŒã€`main` ã§è¡¨ç¤ºã—ãŸ `add` ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ `foo` ã§è¡¨ç¤ºã—ãŸ `add` ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç•°ãªã‚Šã¾ã™ã€‚

Cè¨€èªã®ç”¨èªã§è¨€ã†ã¨ã€`foo3.c` ã® `add` ã‚‚ `main3.c` ã® `add` ã‚‚ãã‚Œãã‚Œå†…éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã‚’æŒã¤ãŸã‚ã€ç¿»è¨³å˜ä½ã”ã¨ã«åˆ¥ã®å®Ÿä½“ã‚’æŒã¤ã“ã¨ã‚’è¨±å®¹ã•ã‚ŒãŸã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ãŸã ã€ã“ã®å ´åˆã¯é–¢æ•°ã®å†…å®¹ã‚‚åŒã˜ãªã®ã§ã€ãƒªãƒ³ã‚¯æ™‚ã®æœ€é©åŒ–ã«ã‚ˆã£ã¦åŒã˜å®Ÿä½“ã«ã¾ã¨ã‚ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼ˆè‡ªä¿¡ãªã—ï¼‰ã€‚

æœ€å¾Œã«ã€2ã¤ã®ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã§åŒã˜é–¢æ•°ã‚’ `static` ãªã—ã§å®šç¾©ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```c:foo4.c
#include <stdio.h>

int add(int a, int b)
{
    return a + b;
}

void foo(void)
{
    printf("foo: %p, %d\n", add, add(3, 5));
}
```

```c:main4.c
#include <stdio.h>

int add(int a, int b)
{
    return a + b;
}

extern void foo(void);

int main(void)
{
    printf("main: %p, %d\n", add, add(3, 5));
    foo();
}
```

```
$ cc -o exe4 foo4.c main4.c
duplicate symbol '_add' in:
    /private/var/folders/yg/36z4_5q142d6s6sn2y53gsd00000gn/T/main4-74bb37.o
    /private/var/folders/yg/36z4_5q142d6s6sn2y53gsd00000gn/T/foo4-3ec783.o
ld: 1 duplicate symbols
clang: error: linker command failed with exit code 1 (use -v to see invocation)
```

ãƒªãƒ³ã‚¯ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸã€‚

Cè¨€èªã®ç”¨èªã§è¨€ã†ã¨ã€`add` ã¯å¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã‚’æŒã¡ã¾ã™ãŒã€**å¤–éƒ¨å®šç¾©** (external definition) ãŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ä¸­ã«è¤‡æ•°å­˜åœ¨ã™ã‚‹ã®ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚å¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã‚’æŒã¤ä¸€ã¤ã®è­˜åˆ¥å­ã«å¯¾ã™ã‚‹å¤–éƒ¨å®šç¾©ã¯é«˜ã€…1ã¤ã—ã‹å­˜åœ¨ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ï¼ˆãã®è­˜åˆ¥å­ãŒå®Ÿéš›ã«ä½¿ç”¨ã•ã‚Œã‚‹å ´åˆã¯ã€ã¡ã‚‡ã†ã©1ã¤ï¼‰ã€‚

ä¸€èˆ¬è«–ã¯Cã®è¦æ ¼ã‚’è¦‹ã¦ã‚‚ã‚‰ã†ã¨ã—ã¦ã€é–¢æ•°ãŒå¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ï¼ˆJISã®è¨³èªã§ã¯ã€Œå¤–éƒ¨çµåˆã€ï¼‰ã‚’æŒã¤ã¨ã¯ã€ã–ã£ãã‚Šã„ã†ã¨ `static` ãŒã¤ã„ã¦ã„ãªã„é–¢æ•°ã®ã“ã¨ã§ã™ã€‚

ã¾ãŸã€é–¢æ•°å®šç¾©ãŒå¤–éƒ¨å®šç¾©ã§ã‚ã‚‹ã¨ã¯ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©ã§ã¯ãªã„ã‚‚ã®ã®ã“ã¨ã§ã™ã€‚åŒã˜è­˜åˆ¥å­ã®å¤–éƒ¨å®šç¾©ãŒä¸€ã¤ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä¸­ã«è¤‡æ•°å­˜åœ¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã§ã™ï¼ˆC17 6.9 æ®µè½5ï¼‰ã€‚

## ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³é–¢æ•°ã¨ã¯

é–¢æ•°ã« `inline` é–¢æ•°æŒ‡å®šå­ã‚’ã¤ã‘ã‚‹ã¨ã€ãã®é–¢æ•°ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³é–¢æ•°ã«ãªã‚Šã€é–¢æ•°å‘¼ã³å‡ºã—ãŒé«˜é€Ÿã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å…¸å‹çš„ã«ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ã«ã‚ˆã£ã¦é«˜é€ŸåŒ–ãŒå®Ÿç¾ã•ã‚Œã¾ã™ãŒã€å®Ÿéš›ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ã•ã‚Œã‚‹ã¨ã¯é™ã‚‰ãªã„ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚è©³ã—ã„ã“ã¨ã¯Cã®è¦æ ¼ã§ã¯å‡¦ç†ç³»å®šç¾© (implementation-defined) ã ã£ãŸã‚Šæœªè¦å®š (unspecified) ã ã£ãŸã‚Šã—ã¾ã™ã€‚

ã‚‚ã†å°‘ã—è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚

ã¾ãšã€å†…éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã‚’æŒã¤é–¢æ•°ï¼ˆ`static` ãŒã¤ã„ãŸé–¢æ•°ï¼‰ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æŒ‡å®šã§ãã¾ã™ã€‚ä¾‹ãˆã°

```c
static inline int add(int a, int b)
{
    return a + b;
}
```

ã¿ãŸã„ãªã‚„ã¤ã§ã™ã­ã€‚å†…éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã‚Œã°è‰¯ã„ã®ã§ã€

```c
static int add(int a, int b); // å†…éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã¨ã—ã¦å®£è¨€ã™ã‚‹

int main(void)
{
    printf("%d\n", add(3, 5));
}

inline int add(int a, int b)
{
    return a + b;
}
```

ã¨ã„ã†æ›¸ãæ–¹ã‚‚ã§ãã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“ã€å®Ÿéš›ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã•ã‚Œã‚‹ã‹ã¯å‡¦ç†ç³»æ¬¡ç¬¬ã§ã™ã€‚

å¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã‚’æŒã¤é–¢æ•°ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æŒ‡å®šã™ã‚‹å ´åˆã¯ã€`extern` ã®æœ‰ç„¡ã«ã‚ˆã£ã¦æŒ™å‹•ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚C17 6.7.4 æ®µè½7ã«ã‚ˆã‚‹ã¨ã€å¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã‚’æŒã¤é–¢æ•°ã«ã¤ã„ã¦

* `inline` é–¢æ•°æŒ‡å®šå­ä»˜ãã§å®£è¨€ã•ã‚ŒãŸé–¢æ•°ã¯ã€åŒã˜ç¿»è¨³å˜ä½å†…ã«å®šç¾©ã‚’æŒãŸãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚
* ã‚ã‚‹é–¢æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã®å®£è¨€ãŒå…¨ã¦ã€Œ`inline` é–¢æ•°æŒ‡å®šå­ä»˜ãã§ã€`extern` ãªã—ã€ã§ã‚ã‚Œã°ã€ãã®ç¿»è¨³å˜ä½å†…ã§ã®å®šç¾©ã¯**ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©** (inline definition) ã¨ãªã‚‹ã€‚
    * ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©ã¯å¤–éƒ¨å®šç¾©ã‚’ä¸ãˆãªã„ã€‚
    * ã‚ã‚‹ç¿»è¨³å˜ä½ã«ã‚ã‚‹è­˜åˆ¥å­ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©ãŒã‚ã£ã¦ã‚‚ã€ä»–ã®ç¿»è¨³å˜ä½ã«ãã®è­˜åˆ¥å­ã®å¤–éƒ¨å®šç¾©ãŒã‚ã‚‹ã“ã¨ã¯é˜»å®³ã•ã‚Œãªã„ã€‚
    * é–¢æ•°å‘¼ã³å‡ºã—ã§ã¯ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©ãŒå¤–éƒ¨å®šç¾©ã®ä»£ã‚ã‚Šã«ä½¿ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ï¼ˆå®Ÿéš›ã©ã†ãªã‚‹ã‹ã¯æœªè¦å®šï¼‰ã€‚

ã¨ã®ã“ã¨ã§ã™ã€‚

ä¾‹ãˆã°ã€æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ï¼š

```c:main5.c
#include <stdio.h>

inline int add(int a, int b)
{
    return a + b;
}

int main(void)
{
    printf("main: %p, %d\n", add, add(3, 5));
}
```

```
$ cc -oexe5 -std=c17 main5.c
Undefined symbols for architecture arm64:
  "_add", referenced from:
      _main in main5-9ea94f.o
      _main in main5-9ea94f.o
ld: symbol(s) not found for architecture arm64
clang: error: linker command failed with exit code 1 (use -v to see invocation)
```

ç†ç”±ã¨ã—ã¦ã¯ã€`main5.c` ã§ã® `add` ã¯å¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã‚’æŒã¡ã€`inline` ä»˜ãã§ `extern` ãªã—ãªã®ã§ã€å¤–éƒ¨å®šç¾©ã‚’ä¸ãˆãªã„ã€ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ä¸€æ–¹ã§ã€æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒé€šã‚Šã¾ã™ï¼š

```c:main6.c
#include <stdio.h>

extern inline int add(int a, int b)
{
    return a + b;
}

int main(void)
{
    printf("main: %p, %d\n", add, add(3, 5));
}
```

```
$ cc -oexe6 -std=c17 main6.c
$ ./exe6
main: 0x1047ebf18, 8
```

ã“ã®å ´åˆã€`add` ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©ã«ã¯è©²å½“ã—ãªã„ãŸã‚ã€Cã®è¦æ ¼ã§ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ãŒèµ·ã“ã‚‹ã‹ã©ã†ã‹ã«ã¤ã„ã¦ã¯ä½•ã‚‚è¨€ã£ã¦ã„ãªã„ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã—ã‹ã—ã€å¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã‚’æŒã¤è­˜åˆ¥å­ã®å¤–éƒ¨å®šç¾©ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä¸­ã«é«˜ã€…ä¸€ã¤ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚‹ã®ã§ã€å‡¦ç†ç³»ãŒã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ç­‰ã®æœ€é©åŒ–ã‚’è¡Œã†ã“ã¨ã«æ”¯éšœã¯ãªã„ã§ã—ã‚‡ã†ã€‚

ç¿»è¨³å˜ä½ä¸­ã« `extern` ä»˜ãã®å®£è¨€ãŒä¸€ã¤ã§ã‚‚ã‚ã‚Œã°ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©ã«ã¯è©²å½“ã—ãªããªã‚Šã€å¤–éƒ¨å®šç¾©ã‚’ä¸ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

```c:main7.c
#include <stdio.h>

inline int add(int a, int b)
{
    return a + b;
}

extern int add(int a, int b);

int main(void)
{
    printf("main: %p, %d\n", add, add(3, 5));
}
```

```
$ cc -oexe7 -std=c17 main7.c
$ ./exe7
main: 0x100c47f18, 8
```

## ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµ„ã¿åˆã‚ã›ã‚‹å ´åˆã¯ã©ã†ã™ã‚Œã°ã„ã„ã®ã‹

Cè¨€èªã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚’æ›¸ãã¨ãã€ã‚ã‚‹é–¢æ•°ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©ã‚’æä¾›ã—ã¤ã¤ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã§ããªã„å ´åˆï¼ˆä¾‹ãˆã°ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–ã‚ŠãŸã„å ´åˆï¼‰ç”¨ã®å¤–éƒ¨å®šç¾©ã‚‚ç”¨æ„ã—ã¦ãŠãã¨è‰¯ã•ãã†ã§ã™ã€‚ãã†ã„ã†å ´åˆã®æ›¸ãæ–¹ã‚’è€ƒãˆã¦ã¿ã¾ã™ã€‚

ã¾ãšã€ãƒ˜ãƒƒãƒ€ãƒ¼ã§ã¯æ¬¡ã®ã‚ˆã†ã« `static` ã‚‚ `extern` ã‚‚ãªã„ `inline` é–¢æ•°ã¨ã—ã¦å®šç¾©ã—ã¾ã™ï¼š

```c:add.h
#if !defined(ADD_H)
#define ADD_H

inline int add(int a, int b)
{
    return a + b;
}

#endif
```

ã¾ã‚ç¿»è¨³å˜ä½ã”ã¨ã«åˆ¥ã®å®Ÿä½“ãŒç”Ÿæˆã•ã‚Œã¦ã‚‚è‰¯ãã€ãªãŠã‹ã¤å¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ã§ã‚ã‚‹å¿…è¦ãŒãªã„ã®ã§ã‚ã‚Œã° `static` ã‚’ã¤ã‘ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ãŒã€ã“ã“ã§ã¯å¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ãŒæ¬²ã—ã„ã¨ã—ã¾ã™ï¼ˆä¾‹ãˆã°ã€Cè¨€èªä»¥å¤–ã®è¨€èªã‹ã‚‰FFIã§å‘¼ã°ã‚Œã‚‹é–¢æ•°ã‚’ç”¨æ„ã™ã‚‹ã«ã¯å¤–éƒ¨ãƒªãƒ³ã‚±ãƒ¼ã‚¸ãŒå¿…è¦ã§ã™ï¼‰ã€‚

ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©ã ã‘ã§ã¯å¤–éƒ¨å®šç¾©ãŒç”Ÿæˆã•ã‚Œãªã„ã®ã§ã€ã©ã“ã‹ã®ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆç¿»è¨³å˜ä½ï¼‰ã§ `extern` ä»˜ãã® `add` ã®å®£è¨€ã‚‚ç”¨æ„ã—ã¾ã™ï¼ˆå®šç¾©ã§ã¯ãƒ€ãƒ¡ã§ã™ï¼‰ï¼š

```c:add.c
#include "add.h"

extern int add(int a, int b);
/* ã“ã“ã§
extern int add(int a, int b)
{
    return a + b;
}
ã¨å®šç¾©ã‚’æ›¸ã„ã¦ã—ã¾ã†ã¨ã€Œå¤–éƒ¨å®šç¾©ãŒé«˜ã€…ä¸€ã¤ã€ã«åã™ã‚‹ã€‚
*/
/*
ã“ã“ã§
inline int add(int a, int b);
ã¨æ›¸ã„ã¦ã—ã¾ã†ã¨å¤–éƒ¨å®šç¾©ãŒç”Ÿæˆã•ã‚Œãªã„ã€‚
 */
/*
externãªã—ã®
int add(int a, int b);
ã§ã‚‚è‰¯ã„ã€‚
 */
/*
ä½•ã‚‰ã‹ã®äº‹æƒ…ã§ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©ã¨ãã†ã§ãªã„å®šç¾©ã§åˆ¥ã®å®šç¾©ã‚’æ¡ç”¨ã—ãŸã‘ã‚Œã°ã€#include "add.h" ã›ãšã«
int add(int a, int b)
{
    ...
}
ã¨æ›¸ãã€‚
 */
```

åˆ©ç”¨ã™ã‚‹å´ã¯ã€æ™®é€šã« `#include "add.h"` ã—ã¾ã™ï¼š

```c:foo8.c
#include <stdio.h>
#include "add.h"

void foo(void)
{
    printf("foo: %p, %d\n", add, add(3, 5));
}
```

```c:main8.c
#include <stdio.h>
#include "add.h"

/* ã“ã“ã§
extern int add(int a, int b);
ã¨æ›¸ã„ã¦ã—ã¾ã†ã¨å¤–éƒ¨å®šç¾©ãŒç”Ÿæˆã•ã‚Œã€add.c ã¨é‡è¤‡ã™ã‚‹ã®ã§ãƒ€ãƒ¡ã€‚
 */

extern void foo(void);

int main(void)
{
    printf("main: %p, %d\n", add, add(3, 5));
    foo();
}
```

```
$ cc -oexe8 -std=c17 main8.c foo8.c add.c
$ ./exe8
main: 0x102917f58, 8
foo: 0x102917f58, 8
```

ç„¡äº‹ã«å¤–éƒ¨å®šç¾©ãŒä¸€å€‹ã ã‘ç”Ÿæˆã•ã‚Œã€ã†ã¾ãã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§ãã¾ã—ãŸã€‚

ã“ã®å½¢ãŒãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã ã¨æ€ã†ã®ã§ã™ãŒã€ã‚ã¾ã‚Šè¦‹ã‹ã‘ãŸã“ã¨ãŒãªã„æ°—ãŒã—ã¾ã™ã€‚ã¿ã‚“ãª `static inline` ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã¯ã€‚`static inline` ã ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ã§å®Œçµã—ã¾ã™ã—ã­ã€‚

## `__attribute__((gnu_inline))` ã«ã¤ã„ã¦

GCCã¯C89ã®æ™‚ä»£ã‹ã‚‰ç‹¬è‡ªæ‹¡å¼µã¨ã—ã¦ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã—ãŸã€‚ãã®ä»•æ§˜ã¯C99ã®ã‚‚ã®ã¨ã¯å¾®å¦™ã«é•ã†ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚GCCã« `-std=gnu89` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¾ãŸã¯ `-fgnu89-inline` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã™ã‹ã€ã¾ãŸã¯é–¢æ•°ã« `gnu_inline` å±æ€§ã‚’ã¤ã‘ã‚‹ã¨å¤ã„ä»•æ§˜ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚ã“ã“ã§ã¯å¤ã„ä»•æ§˜ã‚’ã€ŒGNU 89ãƒ¢ãƒ¼ãƒ‰ã€ã¨å‘¼ã¶ã“ã¨ã«ã—ã¾ã™ã€‚

å‚è€ƒï¼šã€Œ[Inline (Using the GNU Compiler Collection (GCC))](https://gcc.gnu.org/onlinedocs/gcc/Inline.html)ã€

GNU 89ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€`static` ã‚‚ `extern` ã‚‚ã¤ã‹ãªã„ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³é–¢æ•°ã¯ã€å¤–éƒ¨å®šç¾©ã‚’ä¸ãˆã¾ã™ã€‚

GNU 89ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€`extern inline` ãŒã¤ã„ãŸé–¢æ•°ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ã®ã¿ã«ä½¿ç”¨ã•ã‚Œã€å¤–éƒ¨å®šç¾©ã‚’ä¸ãˆã¾ã›ã‚“ã€‚Cæ¨™æº–ã®ã€Œã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©ã€ã«ç›¸å½“ã™ã‚‹ã¨è€ƒãˆã¦è‰¯ã•ãã†ã§ã™ã€‚

ä¾‹ãˆã°ã€æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã¯ã€`foo` ã®æ–¹ã§å¤–éƒ¨å®šç¾©ãŒä¸ãˆã‚‰ã‚Œã€`main` ã¨ `foo` ã®ä¸¡æ–¹ã§ `add` ã¯åŒã˜å®Ÿä½“ã‚’æŒ‡ã—ã¾ã™ï¼š

```c:foo-gnu89.c
#include <stdio.h>

__attribute__((gnu_inline))
inline int add(int a, int b)
{
    return a + b;
}

void foo(void)
{
    printf("foo: %p, %d\n", add, add(3, 5));
}
```

```c:main-gnu89.c
#include <stdio.h>

extern int add(int a, int b);
extern void foo(void);

int main(void)
{
    printf("main: %p, %d\n", add, add(3, 5));
    foo();
}
```

```
$ gcc -oexe-gnu89 main-gnu89.c foo-gnu89.c
$ ./exe-gnu89
main: 0x5650472dd18c, 8
foo: 0x5650472dd18c, 8
```

ä¸€æ–¹ã€æ¬¡ã®ä¾‹ã¯ `add` ã®å¤–éƒ¨å®šç¾©ãŒãªã„ã®ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ï¼š

```c:main-gnu89-bad.c
#include <stdio.h>

__attribute__((gnu_inline))
extern inline int add(int a, int b)
{
    return a + b;
}

int main(void)
{
    printf("main: %p, %d\n", add, add(3, 5));
}
```

```
$ gcc main-gnu89-bad.c
/usr/bin/ld: /tmp/ccd9D6OW.o: in function `main':
main-gnu89-bad.c:(.text+0x13): undefined reference to `add'
/usr/bin/ld: main-gnu89-bad.c:(.text+0x1c): undefined reference to `add'
collect2: error: ld returned 1 exit status
```

ç¾åœ¨ã©ã¡ã‚‰ã®ãƒ¢ãƒ¼ãƒ‰ï¼ˆGNU 89 vs C99ï¼‰ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ã¯ã€`__GNUC_STDC_INLINE__` ãƒã‚¯ãƒ­ã¨ `__GNUC_GNU_INLINE__` ãƒã‚¯ãƒ­ã§åˆ¤åˆ¥ã§ãã‚‹ã‚ˆã†ã§ã™ï¼ˆå‚è€ƒï¼š[Common Predefined Macros (The C Preprocessor)](https://gcc.gnu.org/onlinedocs/cpp/Common-Predefined-Macros.html)ï¼‰ã€‚

```c
#include <stdio.h>
int main()
{
#if defined(__GNUC_STDC_INLINE__)
    puts("__GNUC_STDC_INLINE__");
#endif
#if defined(__GNUC_GNU_INLINE__)
    puts("__GNUC_GNU_INLINE__");
#endif
}
```

## always_inline, forceinline

Cæ¨™æº–ã® `inline` ã¯ã‚ãã¾ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ã«å¯¾ã™ã‚‹ãƒ’ãƒ³ãƒˆã§ã€å®Ÿéš›ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ãŒèµ·ã“ã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ã«ã‚ˆã£ã¦ã¯ã€ã‚‚ã£ã¨å¼·åˆ¶åŠ›ã®å¼·ã„å±æ€§ã‚’æä¾›ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

GCCã‚„äº’æ›ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ï¼ˆClangãªã©ï¼‰ã¯ `always_inline` å±æ€§ã«ã‚ˆã‚Šã€é–¢æ•°å‘¼ã³å‡ºã—ãŒã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’å¼·åˆ¶ã§ãã¾ã™ï¼š[Common Function Attributes (Using the GNU Compiler Collection (GCC))](https://gcc.gnu.org/onlinedocs/gcc/Common-Function-Attributes.html#index-always_005finline-function-attribute)

MSVCã¯ `__forceinline` ã¨ã„ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æä¾›ã—ã¦ã„ã¾ã™ï¼š[Inline Functions (C++) | Microsoft Learn](https://learn.microsoft.com/en-us/cpp/cpp/inline-functions-cpp?view=msvc-170)

è©³ã—ãã¯ã€å„ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ç”¨èªã«ã¤ã„ã¦

é–¢é€£ã™ã‚‹ç”¨èªã®ã€C17ã«ãŠã‘ã‚‹å®šç¾©ã®å ´æ‰€ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™ã€‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·ã€æ®µè½ç•ªå·ã¯C17ã®ã‚‚ã®ã‚’æŒ‡ã—ã¾ã™ã€‚è¨³èªã¯JIS X 3010ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

* ç¿»è¨³å˜ä½ (translation unit) 5.1.1.1
* çµåˆ (linkage) 6.2.2
    * å¤–éƒ¨çµåˆ (external linkage)
    * å†…éƒ¨çµåˆ (internal linkage)
    * ç„¡çµåˆ (no linkage)
* å®£è¨€ (declaration) 6.7
* å®šç¾© (definition) 6.7 æ®µè½5
* è¨˜æ†¶åŸŸã‚¯ãƒ©ã‚¹æŒ‡å®šå­ (storage-class specifier) 6.7.1
    * `typedef`, `extern`, `static`, `_Thread_local`, `auto`, `register`
* é–¢æ•°æŒ‡å®šå­ (function specifier) 6.7.4
    * `inline`, `_Noreturn`
    * ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾© (inline definition) 6.7.4
* å¤–éƒ¨å®£è¨€ (external declaration) 6.9
* å¤–éƒ¨å®šç¾© (external definition) 6.9 æ®µè½5

## å‚è€ƒ

* GCC: [Inline (Using the GNU Compiler Collection (GCC))](https://gcc.gnu.org/onlinedocs/gcc/Inline.html)
* Clang: [Language Compatibility -- C99 inline functions](https://clang.llvm.org/compatibility.html#inline)
* [Inline Functions In C](https://www.greenend.org.uk/rjk/tech/inline.html)
